#!/bin/bash
###
# Cf https://github.com/ffuf/ffuf#usage
# Use -fl X to skip responses with X number of lines
#     -fs X to skip responses with a response size of X bytes
#     -fw X to skip responses with X words
###
EXTRA_FFUF_OPTS="-s"
COOKIES="a=b"
AUTHENTICATION_HEADER="X-SRC: RIGHETTOD"
PROXY=""
DICT_HOME="/tools/sec-lists/Discovery/Web-Content"
REPORT_HOME="/tools/reports"
FFUF_RUN_STORAGE="$REPORT_HOME/ffuf_run_files_api"
IGNORE_HTTP_CODES="302,404,405"
THREAD_COUNT="10"
###
if [ "$PROXY" != "" ];
then
	ffuf_proxy="-x $PROXY"
else
	ffuf_proxy=""
fi
base_target=$1
rm -rf $FFUF_RUN_STORAGE 2>/dev/null 
mkdir $FFUF_RUN_STORAGE 2>/dev/null
# Cf https://github.com/ffuf/ffuf#usage
opts="$EXTRA_FFUF_OPTS $ffuf_proxy -fc $IGNORE_HTTP_CODES -c -ic -timeout 30 -t $THREAD_COUNT -o $REPORT_HOME/ffuzz-api.json -of json -od $FFUF_RUN_STORAGE"
dicts=("graphql.txt" "swagger.txt" "spring-boot.txt" "axis.txt" "api/actions-lowercase.txt" "raft-small-words-lowercase.txt")
http_methods=("INVALID" "OPTIONS" "HEAD" "GET" "POST" "PUT" "DELETE" "TRACE" "PURGE" "PROPFIND" "PROPPATCH" "MKCOL" "COPY" "MOVE" "LOCK" "UNLOCK" "VERSION-CONTROL" "REPORT" "CHECKOUT" "CHECKIN" "UNCHECKOUT" "MKWORKSPACE" "UPDATE" "LABEL" "MERGE" "BASELINE-CONTROL" "MKACTIVITY" "ORDERPATCH" "ACL" "PATCH" "SEARCH" "ARBITRARY" "BIND" "LINK" "MKCALENDAR" "MKREDIRECTREF" "PRI" "QUERY" "REBIND" "UNBIND" "UNLINK" "UPDATEREDIRECTREF")
for dict in ${dicts[@]}; do
	entries_count=$(wc -l $DICT_HOME/$dict | cut -d' ' -f1)
	if [[ "$dict" == "api/actions-lowercase.txt" || "$dict" == "raft-small-words-lowercase.txt" ]];
	then
		# Try using different HTTP methods
		for http_method in ${http_methods[@]}; do
			echo -e "\e[93m[HTTP $http_method] Test using '$dict' ($entries_count entries) ...\e[0m"
			ffuf -X $http_method -H "Content-Type: application/json" $opts -b "$COOKIES" -H "$AUTHENTICATION_HEADER" -w $DICT_HOME/$dict -u $base_target/FUZZ
		done
	else
		# Try using HTTP methods GET
		echo -e "\e[93m[HTTP GET] Test using '$dict' ($entries_count entries) ...\e[0m"
		ffuf $opts -w $DICT_HOME/$dict -b "$COOKIES" -H "$AUTHENTICATION_HEADER" -u $base_target/FUZZ	
	fi
done
