#!/bin/bash
#############################################################################################
# Script to identify, as much as possible, the following elements based on a 
# AWS CLI credentials file provided:
#   - Existing cloud assets.
#   - Actions allowed to be performed on cloud assets (CRUD).
#   - Access to sensitive informations.
#   - Permissions, roles, identities, etc.
#
#
# Requirements in terms of software:
#   AWS CLI in PATH: https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html                   
# 	apt install aws-cli miller
# 
#
# Remark:
#	Focus was made on reliability of data retrieved over the performance aspects.
#############################################################################################

# Constants
COMMANDS=("sts get-caller-identity" "acm get-account-configuration" "acm list-certificates" "codestar list-projects" "kms list-keys" "iam list-users" "iam list-virtual-mfa-devices")
AWSCLI_PREFIX="aws"
WORK_FILE="/tmp/awscli.out"
RESULT_FILE="/tmp/result.csv"

# Entry point
if [ "$#" -lt 2 ]; then
    script_name=$(basename "$0")
    echo "Usage:"
    echo "   $script_name [AWS_CREDENTIALS_FILE] [AWS_REGION]"
    echo ""
    echo "Call example:"
    echo "    $script_name /tmp/credentials eu-west-1"
    echo "    $script_name ~/.aws/credentials eu-west-1"
    echo ""
    echo "AWS credentials file syntax:"
    echo "    Consult https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-files.html#cli-configure-files-format"
    exit 1
fi
export AWS_CONFIG_FILE="$1"
export AWS_DEFAULT_REGION="$2"
export AWS_DEFAULT_OUTPUT="text"

# Utility functions
function write_step(){
    echo -e "\e[93m[+] $1\e[0m"
}

function check_aws_cli_availability(){
    which aws 1>/dev/null 2>&1
    return $?
}

function test_command(){
    command_to_exec="$1"
    full_cmd="$AWSCLI_PREFIX $command_to_exec"
    $full_cmd 1> $WORK_FILE 2>&1
    is_allowed=$(grep -c "AccessDeniedException" $WORK_FILE)
    rm $WORK_FILE    
    if [ $is_allowed -eq 0 ]
    then
        allowed="Yes"
    else 
        allowed="No"
    fi
    echo "$AWS_PROFILE,$AWS_DEFAULT_REGION,\"$full_cmd\",$allowed" >> $RESULT_FILE
}

# Main processing
write_step "Check AWS CLI..."
check_aws_cli_availability
if [ $? -ne 0 ]
then
    echo "AWS CLI not installed or not available in PATH!"
    exit 1
else
    $AWSCLI_PREFIX --version | cut -d' ' -f1
fi
write_step "Test all commands using all profiles from the file '$AWS_CONFIG_FILE'..."
echo "Profile,Region,Command,Allowed" > $RESULT_FILE
for cred_profile in $($AWSCLI_PREFIX configure list-profiles)
do
    export AWS_PROFILE=$cred_profile
    printf "Use profile [%-15s] with region [%-15s]..." "$AWS_PROFILE" "$AWS_DEFAULT_REGION" 
    for command in "${COMMANDS[@]}"
    do
        test_command "$command"
    done
    echo "done."
done
write_step "Results:"
mlr --icsv --opprint sort -r Allowed $RESULT_FILE
rm $WORK_FILE $RESULT_FILE 2>/dev/null

