#!/bin/bash
#############################################################################################
# Script to find missing HTTP response security headers based on
# the OWASP Secure Headers Project recommendations.
#
# Requirements in terms of software:
# 	apt install curl jq
#############################################################################################

# Constants
OSHP_JSON_URL="https://owasp.org/www-project-secure-headers/ci/headers_add.json"
OSHP_WORK_FILE="/tmp/oshp.txt"
WORK_FILE="/tmp/headers.txt"
USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36"

# Entry point
if [ "$#" -lt 1 ]; then
    script_name=$(basename "$0")
    echo "Usage:"
    echo "   $script_name [BASE_URL]"
    echo ""
    echo "Call example:"
    echo "    $script_name https://righettod.eu"
    exit 1
fi

# Utility functions
function write_step(){
    echo -e "\e[93m$1\e[0m"
}

# Main processing
app=$1
write_step "[+] Get OWASP Secure Headers Project recommendations..."
curl -A "$USER_AGENT" -sk $OSHP_JSON_URL | jq -r ".headers[].name" | grep -Ev "(Cache-Control|Clear-Site-Data|Pragma)" | sort -u > $OSHP_WORK_FILE
echo "Done ($(wc -c $OSHP_WORK_FILE))."
write_step "[+] Get app response headers following any HTTP 30x redirections..."
curl -A "$USER_AGENT" -sk -o /dev/null --dump-header $WORK_FILE $app 
awk '!/^[[:space:]]*$/' $WORK_FILE
write_step "[+] Verify headers..."
for header in $(cat $OSHP_WORK_FILE)
do
	found=$(grep -Fic "$header:" $WORK_FILE)
	if [ $found -eq 0 ]
	then
		printf '\e[1;91m%s\e[m' "[Missing] "
	else
		printf '\e[1;92m%s\e[m' "[Present] "
	fi
	printf "%s\n" "$header"
done
rm $OSHP_WORK_FILE $WORK_FILE
